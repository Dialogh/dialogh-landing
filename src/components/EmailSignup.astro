---
import ScrollDownButton from "./ScrollDownButton.astro";
import LineImg from "../assets/images/line.webp";
import { Image } from "astro:assets";
---

<div class="max-w-md mx-auto text-center relative z-10 px-4 mb-4">
  <h1 class="text-2xl sm:text-3xl md:text-4xl mb-4">
    dialogh is <span class="evolving-text relative"
      >evolving <Image
        src={LineImg}
        class="absolute -bottom-1 left-2 sm:left-4 md:left-6 w-auto h-auto"
        alt=""
      /></span
    >
  </h1>

  <p
    class="text-sm sm:text-base md:text-lg lg:text-xl max-w-xs sm:max-w-sm md:max-w-md mb-6 sm:mb-8 mx-auto"
    style="color: rgb(0 0 0 / 0.7);"
  >
    A space rebuilt with intention.. for the people who made it what it was.
  </p>

  <form
    class="flex flex-row gap-2 sm:gap-3 max-w-xs sm:max-w-xl md:max-w-lg mx-auto rounded-full p-1.5"
    style="background-color: rgb(0 0 0 / 0.1);"
    name="register"
    id="registerForm"
  >
    <input
      type="email"
      placeholder="Enter Your Email"
      class="flex-1 lg:px-3 sm:px-0 py-1 sm:py-1 text-sm sm:text-base rounded-full focus:outline-none"
      name="data"
      required
    />
    <button
      type="submit"
      class="block px-2 text-sm sm:text-base transition-colors rounded-full"
      style="background-color: var(--color-primary); color: var(--color-secondary);"
    >
      Get Notified
    </button>
  </form>
</div>

<style>
  input::placeholder {
    opacity: 0.7;
  }

  button {
    white-space: nowrap;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registerForm") as HTMLFormElement;

    form?.addEventListener("submit", async function (e) {
      e.preventDefault(); // Prevent the default form submission

      const submitButton = form.querySelector(
        'button[type="submit"]'
      ) as HTMLButtonElement;
      const originalText = submitButton?.textContent || "Get Notified";

      // Show loading state
      if (submitButton) {
        submitButton.textContent = "Submitting...";
        submitButton.disabled = true;
      }

      try {
        const formData = new FormData(form);

        const response = await fetch("/api/submit", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Clear the form
          form.reset();

          // Show success toast
          if (window.showToast) {
            window.showToast({
              type: "success",
              title: "Successfully Registered!",
              message:
                "You'll be notified when Dialogh launches. Welcome to the community!",
              duration: 6000,
            });
          }
        } else {
          // Show error toast
          if (window.showToast) {
            window.showToast({
              type: "error",
              title: "Registration Failed",
              message: result.error || "Failed to submit. Please try again.",
              duration: 5000,
            });
          }
        }
      } catch (error) {
        console.error("Submission error:", error);
        const errorMessage =
          error instanceof Error ? error.message : "Unknown error occurred";

        // Show error toast
        if (window.showToast) {
          window.showToast({
            type: "error",
            title: "Connection Error",
            message: "Failed to submit: " + errorMessage,
            duration: 5000,
          });
        }
      } finally {
        // Restore button state
        if (submitButton) {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      }
    });
  });
</script>
