---
interface Props {
    id: string;
    showArrows?: boolean;
    showDots?: boolean;
    spaceBetween?: number;
    loop?: boolean;
    autoplay?: boolean;
    autoplayDelay?: number;
}

const {
    id = "carousel",
    showArrows = true,
    showDots = true,
    spaceBetween = 16,
    loop = true,
    autoplay = false,
    autoplayDelay = 3000,
} = Astro.props;
---

<div class="swiper-container relative" data-swiper-id={id} data-loop={loop} data-autoplay={autoplay} data-autoplay-delay={autoplayDelay} data-space-between={spaceBetween}>
    <!-- Swiper wrapper -->
    <div class="swiper rounded-2xl overflow-visible" id={`swiper-${id}`}>
        <div class="swiper-wrapper">
            <slot />
        </div>
    </div>

    <!-- Navigation arrows -->

    <div class="swiper-navigation flex items-center gap-2 mt-4 justify-end">
        <button
            class="swiper-button-prev-custom bg-white/10 hover:bg-white/20 rounded-full p-2 text-white/70 hover:text-white transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
            data-prev={id}
            aria-label="Previous slide"
            type="button"
        >
            <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="m15 18-6-6 6-6"></path>
            </svg>
        </button>
        <button
            class="swiper-button-next-custom bg-white/10 hover:bg-white/20 rounded-full p-2 text-white/70 hover:text-white transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
            data-next={id}
            aria-label="Next slide"
            type="button"
        >
            <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="m9 18 6-6-6-6"></path>
            </svg>
        </button>
    </div>
</div>

<script>
    import { Swiper } from "swiper";
    import { Navigation, Pagination, Autoplay } from "swiper/modules";
    import type { Swiper as SwiperType } from "swiper/types";
    import "swiper/css";
    import "swiper/css/navigation";
    import "swiper/css/pagination";
    import "swiper/css/autoplay";

    interface WindowWithCarousel extends Window {
        [key: string]: any;
    }

    declare var window: WindowWithCarousel;

    // Validate Swiper import
    if (!Swiper) {
        console.error(
            "Swiper library failed to load. Carousels will not work.",
        );
    }

    function initSwipers(): void {
        const swiperContainers = document.querySelectorAll("[data-swiper-id]");

        // Helper functions defined outside the loop
        function updatePaginationStyling(
            swiperInstance: SwiperType,
            paginationContainer: HTMLElement | null,
        ): void {
            if (!paginationContainer) return;

            const bullets = paginationContainer.querySelectorAll(
                ".swiper-pagination-bullet-custom",
            );
        }

        function updateNavigationState(
            swiperInstance: SwiperType,
            prevBtn: HTMLButtonElement | null,
            nextBtn: HTMLButtonElement | null,
        ): void {
            if (!prevBtn || !nextBtn) return;
            
            // If loop is enabled and working, always enable buttons
            if (swiperInstance.params.loop) {
                prevBtn.disabled = false;
                nextBtn.disabled = false;
            } else {
                // For non-loop carousels, disable based on position
                prevBtn.disabled = swiperInstance.isBeginning;
                nextBtn.disabled = swiperInstance.isEnd;
            }
            
            console.log(`Navigation state updated:`, {
                activeIndex: swiperInstance.activeIndex,
                slidesLength: swiperInstance.slides.length,
                isBeginning: swiperInstance.isBeginning,
                isEnd: swiperInstance.isEnd,
                loop: swiperInstance.params.loop,
                prevDisabled: prevBtn.disabled,
                nextDisabled: nextBtn.disabled
            });
        }

        swiperContainers.forEach((container) => {
            const id = container.getAttribute("data-swiper-id");
            if (!id) return;

            const swiperElement = container.querySelector(
                `#swiper-${id}`,
            ) as HTMLElement;
            const prevButton = container.querySelector(
                `[data-prev="${id}"]`,
            ) as HTMLButtonElement;
            const nextButton = container.querySelector(
                `[data-next="${id}"]`,
            ) as HTMLButtonElement;

            if (!swiperElement) {
                console.warn(`Swiper element not found for id: ${id}`);
                return;
            }

            // Convert slot content to swiper-slides
            const swiperWrapper =
                swiperElement.querySelector(".swiper-wrapper");
            if (!swiperWrapper) {
                console.warn(`Swiper wrapper not found for id: ${id}`);
                return;
            }

            const children = Array.from(swiperWrapper.children);
            children.forEach((child) => {
                if (!child.classList.contains("swiper-slide")) {
                    child.classList.add("swiper-slide");
                }
            });

            if (children.length === 0) {
                console.warn(`No slides found for carousel: ${id}`);
                return;
            }

            // Get carousel settings from data attributes or use defaults
            const carouselLoop = container.getAttribute('data-loop') === 'true';
            const carouselAutoplay = container.getAttribute('data-autoplay') === 'true';
            const carouselAutoplayDelay = parseInt(container.getAttribute('data-autoplay-delay') || '3000');
            const carouselSpaceBetween = parseInt(container.getAttribute('data-space-between') || '16');

            // Enable loop only if we have enough slides for the fractional slidesPerView
            // For loop to work with fractional slidesPerView, we need at least 2x the slidesPerView
            const maxSlidesPerView = 4; // Our highest slidesPerView is 4
            const shouldEnableLoop = carouselLoop && children.length >= Math.ceil(maxSlidesPerView * 1.5);
            
            const swiperConfig: any = {
                modules: carouselAutoplay ? [Navigation, Pagination, Autoplay] : [Navigation, Pagination],
                spaceBetween: carouselSpaceBetween,
                slidesPerView: 1,
                centeredSlides: false,
                centerInsufficientSlides: true,
                grabCursor: true,
                loop: shouldEnableLoop,
                loopAdditionalSlides: shouldEnableLoop ? 2 : 0,
                allowTouchMove: true,
                watchOverflow: !shouldEnableLoop,
                breakpoints: {
                    320: {
                        slidesPerView: 1,
                        spaceBetween: carouselSpaceBetween,
                    },
                    640: {
                        slidesPerView: Math.min(2, children.length),
                        spaceBetween: carouselSpaceBetween + 4,
                    },
                    768: {
                        slidesPerView: shouldEnableLoop ? 3.2 : Math.min(2.5, children.length),
                        spaceBetween: carouselSpaceBetween + 8,
                    },
                    1024: {
                        slidesPerView: shouldEnableLoop ? 3.5 : Math.min(2.8, children.length),
                        spaceBetween: carouselSpaceBetween + 8,
                    },
                    1280: {
                        slidesPerView: shouldEnableLoop ? 4 : Math.min(3.2, children.length),
                        spaceBetween: carouselSpaceBetween + 8,
                    },
                },
                navigation: false,
                keyboard: {
                    enabled: true,
                    onlyInViewport: true,
                },
                autoplay: carouselAutoplay ? {
                    delay: carouselAutoplayDelay,
                    disableOnInteraction: false,
                } : false,
                a11y: {
                    prevSlideMessage: "Previous slide",
                    nextSlideMessage: "Next slide",
                    paginationBulletMessage: "Go to slide {{index}}",
                },
                on: {
                    init: function (this: SwiperType) {
                        updateNavigationState(this, prevButton, nextButton);
                    },
                    slideChange: function (this: SwiperType) {
                        updateNavigationState(this, prevButton, nextButton);
                    },
                    breakpoint: function (this: SwiperType) {
                        updateNavigationState(this, prevButton, nextButton);
                    },
                },
            };

            try {
                // Validate Swiper before creating instance
                if (!Swiper) {
                    throw new Error("Swiper library not available");
                }

                const swiper = new Swiper(swiperElement, swiperConfig);

                // Validate swiper instance was created successfully
                if (!swiper || !swiper.slideNext) {
                    throw new Error("Swiper instance creation failed");
                }

                // Debug logging
                console.log(`Carousel "${id}" initialized:`, {
                    slides: children.length,
                    allowSlideNext: swiper.allowSlideNext,
                    allowSlidePrev: swiper.allowSlidePrev,
                    swiper: swiper,
                });

                // Add debug function to window for testing
                window[`testCarousel_${id}`] = {
                    slideNext: () => swiper.slideNext(),
                    slidePrev: () => swiper.slidePrev(),
                    swiper: swiper,
                };

                // Add navigation button listeners
                if (prevButton) {
                    prevButton.addEventListener("click", (e) => {
                        e.preventDefault();
                        swiper.slidePrev();
                    });
                }

                if (nextButton) {
                    nextButton.addEventListener("click", (e) => {
                        e.preventDefault();
                        swiper.slideNext();
                    });
                }
            } catch (error) {
                console.error(`Failed to initialize carousel "${id}":`, error);

                // Add fallback behavior when carousel fails
                if (prevButton) {
                    prevButton.style.display = "none";
                }
                if (nextButton) {
                    nextButton.style.display = "none";
                }

                // Add a CSS class to enable basic horizontal scroll as fallback
                swiperElement.classList.add("carousel-fallback");
                console.log(
                    `Carousel "${id}" falling back to basic scroll behavior`,
                );
            }
        });
    }

    // Initialize with proper error handling
    function safeInit(): void {
        try {
            initSwipers();
        } catch (error) {
            console.error("Failed to initialize carousels:", error);
        }
    }

    // Initialize on DOM load
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", safeInit);
    } else {
        // DOM is already ready, initialize immediately
        setTimeout(safeInit, 0);
    }

    // Re-initialize on Astro page load for SPA behavior
    document.addEventListener("astro:page-load", safeInit);

    // Also handle astro:after-swap for better SPA support
    document.addEventListener("astro:after-swap", safeInit);
</script>

<style>
    /* Custom Swiper Styles */
    .swiper-container {
        --swiper-theme-color: rgba(255, 255, 255, 0.8);
    }

    /* Hide default Swiper navigation */
    .swiper-button-next,
    .swiper-button-prev {
        display: none;
    }

    /* Hide default pagination */
    .swiper-pagination {
        display: none;
    }

    /* Custom pagination bullets */
    .swiper-pagination-bullet-custom {
        transition: all 0.3s ease;
    }

    .swiper-pagination-bullet-active-custom {
        background: rgba(255, 255, 255, 0.8) !important;
        transform: scale(1.2);
    }

    /* Smooth slide transitions */
    .swiper-slide {
        transition:
            opacity 0.3s ease,
            transform 0.3s ease;
        height: auto;
        display: flex;
    }

    /* Ensure slides are flex containers for proper card sizing */
    .swiper-slide > * {
        flex: 1;
        min-height: 100%;
    }

    /* Mobile touch feedback */
    @media (hover: none) {
        .swiper {
            cursor: grab;
        }

        .swiper:active {
            cursor: grabbing;
        }
    }

    /* Disabled button styles */
    .swiper-button-prev-custom:disabled,
    .swiper-button-next-custom:disabled {
        opacity: 0.4 !important;
        cursor: not-allowed !important;
    }

    /* Focus styles for accessibility */
    .swiper-button-prev-custom:focus,
    .swiper-button-next-custom:focus,
    .swiper-pagination-bullet-custom:focus {
        outline: 2px solid rgba(255, 255, 255, 0.8);
        outline-offset: 2px;
    }

    /* Allow overflow on medium screens and above for the "coming from right" effect */
    .swiper {
        overflow: hidden;
    }
    
    @media (min-width: 768px) {
        .swiper {
            overflow: visible;
        }
        
        .swiper-wrapper {
            overflow: visible;
        }
        
        .swiper-container {
            overflow: visible;
        }
        
        /* Ensure parent containers don't clip the overflow */
        .swiper-slide {
            overflow: visible;
        }
    }

    /* Improve mobile scrolling */
    .swiper-wrapper {
        transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Fallback styles when Swiper fails */
    .carousel-fallback .swiper-wrapper {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    .carousel-fallback .swiper-slide {
        flex: 0 0 auto;
        scroll-snap-align: start;
        margin-right: 16px;
    }

    .carousel-fallback .swiper-wrapper::-webkit-scrollbar {
        height: 4px;
    }

    .carousel-fallback .swiper-wrapper::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
    }

    .carousel-fallback .swiper-wrapper::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
    }

    .carousel-fallback .swiper-wrapper::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
</style>
